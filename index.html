<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é¦™æ¸¯å¤©æ°£é å ±</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            background-color: #f0f0f0;
            color: #333;
            padding: 20px;
        }

        h1, h2 {
            color: #0066cc;
        }

        .section {
            background-color: #fff;
            padding: 15px;
            margin-bottom: 20px;
            border-radius: 5px;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
        }

        .icon {
            width: 50px;
            height: 50px;
            vertical-align: middle;
        }

        .weather-info {
            margin-top: 10px;
        }

        .weather-info p {
            margin: 5px 0;
        }

        .refresh-time {
            font-size: 0.9em;
            color: #666;
            margin-top: 10px;
        }

        .forecast-grid {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 15px;
            margin-top: 15px;
        }

        .forecast-day {
            text-align: center;
            padding: 12px 8px;
            border: 1px solid #e0e0e0;
            border-radius: 5px;
            background-color: #1b5397;
            min-height: 200px;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            color: white;
        }

        .forecast-day div {
            line-height: 1.5;
            margin: 5px 0;
            font-size: 1em;
        }

        .forecast-day strong {
            display: block;
            margin-bottom: 8px;
            font-size: 1em;
            color: white;
            font-weight: 600;
        }

        .forecast-weather {
            min-height: 40px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            margin: 8px 0;
        }

        .forecast-details {
            margin-top: 8px;
        }

        .forecast-details div {
            margin: 5px 0;
            font-size: 1em;
        }

        .hidden {
            display: none;
        }

        .warning-icon {
            width: 30px;
            height: 30px;
            vertical-align: middle;
            margin-right: 10px;
        }

        .title-icon {
            width: 40px;
            height: 40px;
            vertical-align: middle;
            margin-left: 10px;
        }

        .warning-container {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 10px;
        }

        .sun-moon-info {
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px solid #eee;
        }

        .sun-moon-info p {
            margin: 5px 0;
        }

        .weather-grid {
            display: grid;
            grid-template-columns: 70% 30%;
            gap: 20px;
        }

        .toggle-button {
            background-color: #0066cc;
            color: white;
            padding: 10px 15px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            margin-bottom: 20px;
        }

        .toggle-button:hover {
            background-color: #005bb5;
        }
    </style>
</head>
<body>
    <h1>é¦™æ¸¯å¤©æ°£é å ± <span id="titleIcons"></span></h1>

    <div class="section" id="swtSection">
        <h2>ç‰¹åˆ¥å¤©æ°£æç¤º</h2>
        <p id="swt">è¼‰å…¥ä¸­...</p>
    </div>

    <div class="weather-grid">
        <div class="section">
            <h2>æœ¬æ¸¯åœ°å€å¤©æ°£é å ±</h2>
            <div class="weather-info" id="flw">
                <p><span id="generalSituation">è¼‰å…¥ä¸­...</span></p>
                <p id="tcInfoSection"><span id="tcInfo"></span></p>
                <p id="fireDangerWarningSection"><span id="fireDangerWarning"></span></p>
                <p><span id="forecastPeriod">è¼‰å…¥ä¸­...</span></p>
                <p><span id="forecastDesc">è¼‰å…¥ä¸­...</span></p>
                <p><span id="outlook">è¼‰å…¥ä¸­...</span></p>
                <p><strong>æ›´æ–°æ™‚é–“ï¼š</strong> <span id="updateTime">è¼‰å…¥ä¸­...</span></p>
                <p class="refresh-time"><span id="refreshTime">è¼‰å…¥ä¸­...</span></p>
            </div>
        </div>

        <div class="section">
            <h2>æœ¬æ¸¯åœ°å€å¤©æ°£å ±å‘Š</h2>
            <p id="rhrread">è¼‰å…¥ä¸­...</p>
            <div class="sun-moon-info" id="sunMoonInfo">
                <p id="sunInfo">è¼‰å…¥ä¸­...</p>
                <p id="moonInfo">è¼‰å…¥ä¸­...</p>
            </div>
        </div>
    </div>

    <button class="toggle-button hidden" id="toggleWarningButton" onclick="toggleWarningInfo()">é¡¯ç¤ºè©³ç´°å¤©æ°£è­¦å‘Šè³‡è¨Š</button>

    <div class="section hidden" id="warningInfoSection">
        <h2>è©³ç´°å¤©æ°£è­¦å‘Šè³‡è¨Š</h2>
        <div id="warningInfo">è¼‰å…¥ä¸­...</div>
    </div>

    <div class="section" id="warnsumSection">
        <h2>å¤©æ°£è­¦å‘Šä¸€è¦½</h2>
        <div id="warnsum">è¼‰å…¥ä¸­...</div>
    </div>

    <div class="section">
        <h2>ä¹å¤©å¤©æ°£é å ±</h2>
        <p><strong>å¤©æ°£æ¦‚æ³ï¼š</strong> <span id="fndGeneralSituation">è¼‰å…¥ä¸­...</span></p>
        <p><strong>æ›´æ–°æ™‚é–“ï¼š</strong> <span id="fndUpdateTime">è¼‰å…¥ä¸­...</span></p>
        <div class="forecast-grid" id="fnd">è¼‰å…¥ä¸­...</div>
    </div>

    <script>
        const iconBaseUrl = "https://www.hko.gov.hk/images/HKOWxIconOutline/pic";

        const warningIcons = {
            "WHOT": "https://www.hko.gov.hk/tc/wxinfo/dailywx/images/vhot.gif",
            "WCOLD": "https://www.hko.gov.hk/tc/wxinfo/dailywx/images/cold.gif",
            "WMSGNL": "https://www.hko.gov.hk/tc/wxinfo/dailywx/images/sms.gif",
            "WTMW": "https://www.hko.gov.hk/tc/wxinfo/dailywx/images/tsunami-warn.gif",
            "WTS": "https://www.hko.gov.hk/tc/wxinfo/dailywx/images/ts.gif",
            "WL": "https://www.hko.gov.hk/tc/wxinfo/dailywx/images/landslip.gif",
            "WFNTSA": "https://www.hko.gov.hk/tc/wxinfo/dailywx/images/ntfl.gif",
            "WFROST": "https://www.hko.gov.hk/tc/wxinfo/dailywx/images/frost.gif",
            "WFIREY": "https://www.hko.gov.hk/tc/wxinfo/dailywx/images/firey.gif",
            "WFIRER": "https://www.hko.gov.hk/tc/wxinfo/dailywx/images/firer.gif",
            "WRAINA": "https://www.hko.gov.hk/tc/wxinfo/dailywx/images/raina.gif",
            "WRAINR": "https://www.hko.gov.hk/tc/wxinfo/dailywx/images/rainr.gif",
            "WRAINB": "https://www.hko.gov.hk/tc/wxinfo/dailywx/images/rainb.gif",
            "TC1": "https://www.hko.gov.hk/tc/wxinfo/dailywx/images/tc1.gif",
            "TC3": "https://www.hko.gov.hk/tc/wxinfo/dailywx/images/tc3.gif",
            "TC8NE": "https://www.hko.gov.hk/tc/wxinfo/dailywx/images/tc8ne.gif",
            "TC8SE": "https://www.hko.gov.hk/tc/wxinfo/dailywx/images/tc8b.gif",
            "TC8SW": "https://www.hko.gov.hk/tc/wxinfo/dailywx/images/tc8c.gif",
            "TC8NW": "https://www.hko.gov.hk/tc/wxinfo/dailywx/images/tc8d.gif",
            "TC9": "https://www.hko.gov.hk/tc/wxinfo/dailywx/images/tc9.gif",
            "TC10": "https://www.hko.gov.hk/tc/wxinfo/dailywx/images/tc10.gif"
        };

        function formatDate(dateStr) {
            const year = dateStr.substring(0, 4);
            const month = dateStr.substring(4, 6);
            const day = dateStr.substring(6, 8);
            const date = new Date(`${year}-${month}-${day}`);
            const weekdays = ["æ—¥", "ä¸€", "äºŒ", "ä¸‰", "å››", "äº”", "å…­"];
            const weekday = weekdays[date.getDay()];
            return `${parseInt(month)}æœˆ${parseInt(day)}æ—¥ï¼ˆ${weekday}ï¼‰`;
        }

        function getCurrentTime() {
            const now = new Date();
            const hours = String(now.getHours()).padStart(2, '0');
            const minutes = String(now.getMinutes()).padStart(2, '0');
            const seconds = String(now.getSeconds()).padStart(2, '0');
            return `${hours}:${minutes}:${seconds}`;
        }

        function updateWarnings(warnsumData) {
            const warnsumContainer = document.getElementById('warnsum');
            const titleIconsContainer = document.getElementById('titleIcons');
            warnsumContainer.innerHTML = "";
            titleIconsContainer.innerHTML = "";

            let hasActiveWarnings = false;

            for (const [key, warning] of Object.entries(warnsumData)) {
                if (warning.actionCode !== "CANCEL") {
                    hasActiveWarnings = true;
                    const warningHTML = `
                        <div class="warning-container">
                            <img src="${warningIcons[warning.code]}" alt="${warning.name}" class="warning-icon">
                            ${warning.name} (${warning.type || ""})
                        </div>
                    `;
                    warnsumContainer.innerHTML += warningHTML;
                    const titleIconHTML = `<img src="${warningIcons[warning.code]}" alt="${warning.name}" class="title-icon">`;
                    titleIconsContainer.innerHTML += titleIconHTML;
                }
            }

            document.getElementById('warnsumSection').classList.toggle('hidden', !hasActiveWarnings);
        }

        function updateWarningInfo(warningInfoData) {
            const warningInfoContainer = document.getElementById('warningInfo');
            warningInfoContainer.innerHTML = "";

            if (warningInfoData.details && warningInfoData.details.length > 0) {
                warningInfoData.details.forEach(detail => {
                    const warningHTML = `
                        <div class="warning-detail">
                            <h3>${detail.contents[0]}</h3>
                            <p>${detail.contents.slice(1).join("<br>")}</p>
                        </div>
                    `;
                    warningInfoContainer.innerHTML += warningHTML;
                });

                document.getElementById('warningInfoSection').classList.remove('hidden');
                document.getElementById('toggleWarningButton').classList.remove('hidden');
            } else {
                document.getElementById('warningInfo').innerText = "ç„¡æ•¸æ“š";
                document.getElementById('warningInfoSection').classList.add('hidden');
                document.getElementById('toggleWarningButton').classList.add('hidden');
            }
        }

        function updateFnd(fndData) {
            const fndContainer = document.getElementById('fnd');
            const fndGeneralSituation = document.getElementById('fndGeneralSituation');
            const fndUpdateTime = document.getElementById('fndUpdateTime');

            if (fndData.weatherForecast) {
                let forecastHTML = "";
                fndData.weatherForecast.forEach(day => {
                    const formattedDate = formatDate(day.forecastDate);
                    const temperatureRange = `${day.forecastMintemp.value}Â°C-${day.forecastMaxtemp.value}Â°C`;
                    const humidityRange = day.forecastMinrh && day.forecastMaxrh ?
                        `${day.forecastMinrh.value}%-${day.forecastMaxrh.value}%` : "";

                    forecastHTML += `
                        <div class="forecast-day">
                            <div>
                                <strong>${formattedDate}</strong>
                                <div class="forecast-weather">
                                    <img src="${iconBaseUrl}${day.ForecastIcon}.png" alt="${day.forecastWeather}" class="icon">
                                    <div>${day.forecastWeather || "ç„¡æ•¸æ“š"}</div>
                                </div>
                            </div>
                            <div class="forecast-details">
                                <div>ğŸŒ¡ï¸ ${temperatureRange}</div>
                                <div>ğŸ’§ ${humidityRange}</div>
                                <div>ğŸŒ¬ï¸ ${day.forecastWind || "ç„¡æ•¸æ“š"}</div>
                            </div>
                        </div>
                    `;
                });
                fndContainer.innerHTML = forecastHTML;
                fndGeneralSituation.innerText = fndData.generalSituation || "ç„¡æ•¸æ“š";
                fndUpdateTime.innerText = fndData.updateTime ? fndData.updateTime.replace("T", " ").substring(0, 16) : "ç„¡æ•¸æ“š";
            } else {
                fndContainer.innerText = "ç„¡æ•¸æ“š";
                fndGeneralSituation.innerText = "ç„¡æ•¸æ“š";
                fndUpdateTime.innerText = "ç„¡æ•¸æ“š";
            }
        }

        async function getAstroData(dataType, year, month) {
            const response = await fetch(`https://data.weather.gov.hk/weatherAPI/opendata/opendata.php?dataType=${dataType}&year=${year}&month=${month}&rformat=json`);
            return await response.json();
        }

        async function updateSunMoonInfo() {
            try {
                const now = new Date();
                const currentYear = now.getFullYear();
                const currentMonth = now.getMonth() + 1;
                const currentDay = now.getDate();
                
                const tomorrow = new Date(now);
                tomorrow.setDate(tomorrow.getDate() + 1);
                const tomorrowYear = tomorrow.getFullYear();
                const tomorrowMonth = tomorrow.getMonth() + 1;
                const tomorrowDay = tomorrow.getDate();
                
                const todayDateStr = `${currentYear}-${String(currentMonth).padStart(2, '0')}-${String(currentDay).padStart(2, '0')}`;
                const tomorrowDateStr = `${tomorrowYear}-${String(tomorrowMonth).padStart(2, '0')}-${String(tomorrowDay).padStart(2, '0')}`;
                
                const sunDataCurrent = await getAstroData('SRS', currentYear, currentMonth);
                const moonDataCurrent = await getAstroData('MRS', currentYear, currentMonth);
                
                let sunDataNext, moonDataNext;
                if (currentMonth !== tomorrowMonth) {
                    sunDataNext = await getAstroData('SRS', tomorrowYear, tomorrowMonth);
                    moonDataNext = await getAstroData('MRS', tomorrowYear, tomorrowMonth);
                }
                
                const sunData = {
                    data: sunDataCurrent.data.concat(sunDataNext ? sunDataNext.data : [])
                };
                const moonData = {
                    data: moonDataCurrent.data.concat(moonDataNext ? moonDataNext.data : [])
                };

                const processAstroData = (data, type) => {
                    if (!data || !data.data || data.data.length === 0) {
                        return `${type}æ•¸æ“šç„¡æ•ˆ`;
                    }

                    const todayData = data.data.find(item => {
                        const itemDate = item[0].includes('-') ? item[0] : 
                                       `${item[0].substring(0, 4)}-${item[0].substring(4, 6)}-${item[0].substring(6, 8)}`;
                        return itemDate === todayDateStr;
                    });

                    if (!todayData) {
                        return `ä»Šæ—¥${type}æ•¸æ“šç„¡æ•ˆ`;
                    }

                    const tomorrowData = data.data.find(item => {
                        const itemDate = item[0].includes('-') ? item[0] : 
                                       `${item[0].substring(0, 4)}-${item[0].substring(4, 6)}-${item[0].substring(6, 8)}`;
                        return itemDate === tomorrowDateStr;
                    });

                    const getTime = (data, index) => {
                        return data && data[index] && data[index] !== "--:--" ? data[index] : null;
                    };

                    const rise = getTime(todayData, 1);
                    const transit = getTime(todayData, 2);
                    const set = getTime(todayData, 3);
                    const nextRise = getTime(tomorrowData, 1);
                    const nextTransit = getTime(tomorrowData, 2);
                    const nextSet = getTime(tomorrowData, 3);

                    const currentMinutes = now.getHours() * 60 + now.getMinutes();
                    
                    const timeToMinutes = (timeStr) => {
                        if (!timeStr) return Infinity;
                        const [hours, minutes] = timeStr.split(':').map(Number);
                        return hours * 60 + minutes;
                    };

                    if (set && currentMinutes >= timeToMinutes(set)) {
                        return `æ˜å¤© ${type}å‡ºï¸°${nextRise || "--:--"} ${type}ä¸­å¤©ï¸°${nextTransit || "--:--"} ${type}è½ï¸°${nextSet || "--:--"}`;
                    } 
                    else if (transit && currentMinutes >= timeToMinutes(transit)) {
                        return `${type}è½ï¸°${set || "--:--"} æ˜å¤© ${type}å‡ºï¸°${nextRise || "--:--"} ${type}ä¸­å¤©ï¸°${nextTransit || "--:--"}`;
                    } 
                    else if (rise && currentMinutes >= timeToMinutes(rise)) {
                        return `${type}ä¸­å¤©ï¸°${transit || "--:--"} ${type}è½ï¸°${set || "--:--"} æ˜å¤© ${type}å‡ºï¸°${nextRise || "--:--"}`;
                    } 
                    else {
                        return `${type}å‡ºï¸°${rise || "--:--"} ${type}ä¸­å¤©ï¸°${transit || "--:--"} ${type}è½ï¸°${set || "--:--"}`;
                    }
                };

                document.getElementById('sunInfo').innerText = processAstroData(sunData, "æ—¥");
                document.getElementById('moonInfo').innerText = processAstroData(moonData, "æœˆ");

            } catch (error) {
                console.error('ç²å–å¤ªé™½æœˆäº®æ•¸æ“šæ™‚å‡ºéŒ¯:', error);
                document.getElementById('sunInfo').innerText = "å¤ªé™½æ•¸æ“šåŠ è¼‰å¤±æ•—";
                document.getElementById('moonInfo').innerText = "æœˆäº®æ•¸æ“šåŠ è¼‰å¤±æ•—";
            }
        }

        async function fetchWeatherData() {
            try {
                document.getElementById('refreshTime').innerText = getCurrentTime();

                const swtResponse = await fetch('https://data.weather.gov.hk/weatherAPI/opendata/weather.php?dataType=swt&lang=tc');
                const swtData = await swtResponse.json();
                if (swtData.swt && swtData.swt.length > 0 && swtData.swt[0].desc) {
                    document.getElementById('swt').innerText = swtData.swt[0].desc;
                    document.getElementById('swtSection').classList.remove('hidden');
                } else {
                    document.getElementById('swt').innerText = "ç„¡æ•¸æ“š";
                    document.getElementById('swtSection').classList.add('hidden');
                }

                const flwResponse = await fetch('https://data.weather.gov.hk/weatherAPI/opendata/weather.php?dataType=flw&lang=tc');
                const flwData = await flwResponse.json();
                document.getElementById('generalSituation').innerText = flwData.generalSituation || "ç„¡æ•¸æ“š";
                document.getElementById('forecastPeriod').innerText = flwData.forecastPeriod || "ç„¡æ•¸æ“š";
                document.getElementById('forecastDesc').innerText = flwData.forecastDesc || "ç„¡æ•¸æ“š";
                document.getElementById('outlook').innerText = flwData.outlook || "ç„¡æ•¸æ“š";
                document.getElementById('updateTime').innerText = flwData.updateTime || "ç„¡æ•¸æ“š";

                if (flwData.tcInfo) {
                    document.getElementById('tcInfo').innerText = flwData.tcInfo;
                    document.getElementById('tcInfoSection').classList.remove('hidden');
                } else {
                    document.getElementById('tcInfoSection').classList.add('hidden');
                }

                if (flwData.fireDangerWarning) {
                    document.getElementById('fireDangerWarning').innerText = flwData.fireDangerWarning;
                    document.getElementById('fireDangerWarningSection').classList.remove('hidden');
                } else {
                    document.getElementById('fireDangerWarningSection').classList.add('hidden');
                }

                const rhrreadResponse = await fetch('https://data.weather.gov.hk/weatherAPI/opendata/weather.php?dataType=rhrread&lang=tc');
                const rhrreadData = await rhrreadResponse.json();
                if (rhrreadData.temperature?.data?.length > 0) {
                    const tsingYiTemp = rhrreadData.temperature.data[12];
                    const humidity = rhrreadData.humidity.data[0];
                    if (tsingYiTemp && humidity) {
                        document.getElementById('rhrread').innerHTML = `
                            åœ°é»: ${tsingYiTemp.place}<br>
                            æº«åº¦: ${tsingYiTemp.value}Â°C<br>
                            æ¿•åº¦: ${humidity.value}%
                        `;
                    } else {
                        document.getElementById('rhrread').innerText = "ç„¡æ•¸æ“š";
                    }
                } else {
                    document.getElementById('rhrread').innerText = "ç„¡æ•¸æ“š";
                }

                await updateSunMoonInfo();

                const warnsumResponse = await fetch('https://data.weather.gov.hk/weatherAPI/opendata/weather.php?dataType=warnsum&lang=tc');
                const warnsumData = await warnsumResponse.json();
                updateWarnings(warnsumData);

                const warningInfoResponse = await fetch('https://data.weather.gov.hk/weatherAPI/opendata/weather.php?dataType=warninginfo&lang=tc');
                const warningInfoData = await warningInfoResponse.json();
                updateWarningInfo(warningInfoData);

                const fndResponse = await fetch('https://data.weather.gov.hk/weatherAPI/opendata/weather.php?dataType=fnd&lang=tc');
                const fndData = await fndResponse.json();
                updateFnd(fndData);
            } catch (error) {
                console.error('ç²å–å¤©æ°£æ•¸æ“šæ™‚å‡ºéŒ¯:', error);
                document.getElementById('generalSituation').innerText = "æ•¸æ“šåŠ è¼‰å¤±æ•—";
                document.getElementById('tcInfo').innerText = "æ•¸æ“šåŠ è¼‰å¤±æ•—";
                document.getElementById('fireDangerWarning').innerText = "æ•¸æ“šåŠ è¼‰å¤±æ•—";
                document.getElementById('forecastPeriod').innerText = "æ•¸æ“šåŠ è¼‰å¤±æ•—";
                document.getElementById('forecastDesc').innerText = "æ•¸æ“šåŠ è¼‰å¤±æ•—";
                document.getElementById('outlook').innerText = "æ•¸æ“šåŠ è¼‰å¤±æ•—";
                document.getElementById('updateTime').innerText = "æ•¸æ“šåŠ è¼‰å¤±æ•—";
                document.getElementById('rhrread').innerText = "æ•¸æ“šåŠ è¼‰å¤±æ•—";
                document.getElementById('fnd').innerText = "æ•¸æ“šåŠ è¼‰å¤±æ•—";
                document.getElementById('warnsum').innerText = "æ•¸æ“šåŠ è¼‰å¤±æ•—";
                document.getElementById('warningInfo').innerText = "æ•¸æ“šåŠ è¼‰å¤±æ•—";
                document.getElementById('swt').innerText = "æ•¸æ“šåŠ è¼‰å¤±æ•—";
                document.getElementById('sunInfo').innerText = "å¤ªé™½æ•¸æ“šåŠ è¼‰å¤±æ•—";
                document.getElementById('moonInfo').innerText = "æœˆäº®æ•¸æ“šåŠ è¼‰å¤±æ•—";
            }
        }

        fetchWeatherData();
        setInterval(fetchWeatherData, 60000);

        function toggleWarningInfo() {
            const warningInfoSection = document.getElementById('warningInfoSection');
            warningInfoSection.classList.toggle('hidden');
            const button = document.getElementById('toggleWarningButton');
            button.textContent = warningInfoSection.classList.contains('hidden') ? 
                "é¡¯ç¤ºè©³ç´°å¤©æ°£è­¦å‘Šè³‡è¨Š" : "éš±è—è©³ç´°å¤©æ°£è­¦å‘Šè³‡è¨Š";
        }
    </script>
</body>
</html>